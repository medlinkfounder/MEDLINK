<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medlink - Doctors Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ionicons for UI elements -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            color: #333333;
        }
        .main-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%234169e1' fill-opacity='0.05'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h-1v-9h-9v9h-1v-9h-9v9h-1v-9h-9v9h-1v-9h-9v9h-1v-9h-9v9h-1v-9H5V6h1V5zM5 6v9h1V6h9V5H6v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zm10 0v9h1V6h9V5h-9v1zM5 16v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 26v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 36v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 46v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 56v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 66v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 76v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zM5 86v9h1v-9H5zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1zm10 0v9h1v-9h-1z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -1;
        }
        .login-card {
            background-color: #FFFFFF;
            border: 1px solid #e0e0e0;
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .input-group { position: relative; }
        .input-field {
            background-color: #f8f9fa; 
            border: 1px solid #e0e0e0;
            color: #333333;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.75rem 0.75rem 0.75rem 2.75rem;
        }
        .input-field::placeholder { color: #6B7280; }
        .input-field:focus {
            border-color: #4169E1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(65, 105, 225, 0.2);
        }
        .input-icon {
            position: absolute;
            left: 1rem; top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            transition: color 0.3s ease;
            pointer-events: none;
        }
        .input-field:focus + .input-icon { color: #4169E1; }
        .btn-primary {
            background-color: #4169E1;
            color: white;
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #3558C8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);
        }
        .btn-primary:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .text-gradient {
            background: -webkit-linear-gradient(45deg, #4169E1, #5c85ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>
    <div class="main-container relative min-h-screen w-full flex items-center justify-center p-4">

        <!-- This container shows a loading message while Firebase initializes and checks auth state -->
        <div id="loading-container" class="text-center">
            <h1 class="text-3xl font-bold text-gray-700">Med<span class="text-gradient">link</span></h1>
            <p class="text-gray-500 mt-2">Initializing your secure session...</p>
        </div>

        <!-- Right Column (Authentication Forms) -->
        <div id="auth-wrapper" class="hidden w-full max-w-md">
            <!-- Login Card -->
            <div id="login-container" class="login-card p-8 sm:p-10">
                <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">Doctor's Companion</h2>
                <p class="text-gray-500 text-center mb-6 sm:mb-8">Sign in to continue</p>
    
                <form id="login-form" class="space-y-6">
                    <div class="input-group">
                        <input type="email" id="email" placeholder="Email Address" class="input-field w-full" required>
                        <ion-icon name="mail-outline" class="input-icon text-xl"></ion-icon>
                    </div>
                    <div class="input-group">
                        <input type="password" id="password" placeholder="Password" class="input-field w-full" required>
                        <ion-icon name="lock-closed-outline" class="input-icon text-xl"></ion-icon>
                    </div>
                    <div>
                        <button type="submit" id="signin-btn" class="btn-primary w-full py-3 text-base sm:text-lg">Sign In</button>
                    </div>
                </form>
    
                <div id="auth-status" class="mt-4 text-center text-red-500 h-5"></div>
                
                <p class="text-center text-gray-500 mt-4 sm:mt-6">
                    Don't have an account? 
                    <button id="show-signup-btn" class="font-semibold text-blue-600 hover:text-blue-700 transition-colors">Sign Up</button>
                </p>
            </div>
            
            <!-- Signup Card (hidden by default) -->
            <div id="signup-container" class="hidden login-card w-full max-w-md p-8 sm:p-10">
                <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">Create Account</h2>
                <p class="text-gray-500 text-center mb-6 sm:mb-8">Get started with Medlink</p>
    
                <form id="signup-form" class="space-y-6">
                    <div class="input-group">
                        <input type="email" id="signup-email" placeholder="Email Address" class="input-field w-full" required>
                        <ion-icon name="mail-outline" class="input-icon text-xl"></ion-icon>
                    </div>
                    <div class="input-group">
                        <input type="password" id="signup-password" placeholder="Password" class="input-field w-full" required>
                        <ion-icon name="lock-closed-outline" class="input-icon text-xl"></ion-icon>
                    </div>
                    <div>
                        <button type="submit" id="signup-btn" class="btn-primary w-full py-3 text-base sm:text-lg">Sign Up</button>
                    </div>
                </form>
    
                <div id="signup-status" class="mt-4 text-center text-red-500 h-5"></div>
                
                <p class="text-center text-gray-500 mt-4 sm:mt-6">
                    Already have an account? 
                    <button id="show-signin-btn" class="font-semibold text-blue-600 hover:text-blue-700 transition-colors">Sign In</button>
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjf5lp8vhZrpgdOiGyAhH9iSp4UrXXZCM",
            authDomain: "medlink-e4f46.firebaseapp.com",
            projectId: "medlink-e4f46",
            storageBucket: "medlink-e4f46.appspot.com",
            messagingSenderId: "109099855422",
            appId: "1:109099855422:web:9ae346a0f54dead6412b6f",
            measurementId: "G-C4Z1JKBG2E"
        };

        // --- DOM Element References ---
        const loadingContainer = document.getElementById('loading-container');
        const authWrapper = document.getElementById('auth-wrapper');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signinBtn = document.getElementById('signin-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authStatus = document.getElementById('auth-status');
        const signupStatus = document.getElementById('signup-status');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const showSigninBtn = document.getElementById('show-signin-btn');

        // --- Firebase Initialization ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await setPersistence(auth, browserLocalPersistence);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            loadingContainer.innerHTML = '<p class="text-red-500">Error: Could not initialize the application.</p>';
        }

        // --- Core Logic ---
        
        /**
         * Checks Firestore to see if a profile document exists for the given user ID.
         * @param {string} userId The UID of the user from Firebase Auth.
         * @returns {Promise<boolean>} True if the profile exists, false otherwise.
         */
        const checkIfProfileExists = async (userId) => {
            if (!userId) return false;
            const profileRef = doc(db, "doctor_profiles", userId);
            try {
                const docSnap = await getDoc(profileRef);
                return docSnap.exists();
            } catch (error) {
                console.error("Error checking profile existence:", error);
                return false; // Assume no profile on error
            }
        };

        // --- Authentication State Observer ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                console.log("Auth state changed: User is signed in.", user.uid);
                const profileExists = await checkIfProfileExists(user.uid);
                
                if (profileExists) {
                    console.log("Profile exists. Redirecting to dashboard.");
                    window.location.href = 'DOC DASHBOARD.html';
                } else {
                    console.log("Profile does not exist. Redirecting to profile creation.");
                    window.location.href = 'Dotor profile.html';
                }
            } else {
                // User is signed out. Show the authentication forms.
                console.log("Auth state changed: User is signed out.");
                loadingContainer.classList.add('hidden');
                authWrapper.classList.remove('hidden');
                showLoginView();
            }
        });

        // --- UI Toggling Functions ---
        const showLoginView = () => {
            loginContainer.classList.remove('hidden');
            signupContainer.classList.add('hidden');
        };

        const showSignupView = () => {
            loginContainer.classList.add('hidden');
            signupContainer.classList.remove('hidden');
        };
        
        showSignupBtn.addEventListener('click', showSignupView);
        showSigninBtn.addEventListener('click', showLoginView);

        // --- Form Submission Event Listeners ---

        // Sign-in form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authStatus.textContent = '';
            signinBtn.disabled = true;
            signinBtn.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span>';

            try {
                // The onAuthStateChanged observer will handle the redirection automatically
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                authStatus.textContent = getFriendlyAuthError(error.code);
                signinBtn.disabled = false;
                signinBtn.textContent = 'Sign In';
            }
        });

        // Sign-up form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            signupStatus.textContent = '';
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span>';
            
            try {
                // The onAuthStateChanged observer will redirect to the profile page upon successful creation
                await createUserWithEmailAndPassword(auth, signupEmailInput.value, signupPasswordInput.value);
            } catch (error) {
                signupStatus.textContent = getFriendlyAuthError(error.code);
                signupBtn.disabled = false;
                signupBtn.textContent = 'Sign Up';
            }
        });
        
        // --- Helper function for user-friendly error messages ---
        function getFriendlyAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid email or password.';
                case 'auth/email-already-in-use': return 'This email address is already in use.';
                case 'auth/weak-password': return 'Password should be at least 6 characters.';
                default: return 'An unexpected error occurred. Please try again.';
            }
        }
    </script>
</body>
</html>
